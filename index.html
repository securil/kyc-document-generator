<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>KYC ë‹¤ì¤‘ ë¬¸ì„œ ì²˜ë¦¬ ì‹œìŠ¤í…œ - v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        
        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(248,249,250,0.8);
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background: rgba(0,123,255,0.1);
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: rgba(40,167,69,0.1);
        }
        
        .file-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin: 10px auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .progress-container {
            display: none;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 25px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-circle {
            background: #007bff;
            color: white;
        }
        
        .step.completed .step-circle {
            background: #28a745;
            color: white;
        }
        
        .document-section {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }
        
        .document-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-process {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-process:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .btn-process:disabled {
            background: #6c757d;
            transform: none;
            box-shadow: none;
        }
        
        /* ê²€ì¦ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220,53,69,0.25);
        }
        
        .badge {
            font-size: 0.8em;
        }
        
        .conflict-item {
            background: rgba(255,193,7,0.1);
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
        }
        
        .original-data {
            background: rgba(248,249,250,0.8);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .field-group {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            color: #495057;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- í—¤ë” -->
        <div class="text-center mb-4">
            <h1 class="text-white mb-2">
                <i class="bi bi-shield-check"></i>
                KYC ë‹¤ì¤‘ ë¬¸ì„œ ì²˜ë¦¬ ì‹œìŠ¤í…œ
            </h1>
            <p class="text-white-50">ì—¬ê¶Œê³¼ ìš´ì „ë©´í—ˆì¦ì„ ë™ì‹œì— ì²˜ë¦¬í•˜ì—¬ ì •í™•í•œ KYC ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤</p>
        </div>

        <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="step-indicator">
                    <div class="step active">
                        <div class="step-circle">1</div>
                        <small>íŒŒì¼ ì—…ë¡œë“œ</small>
                    </div>
                    <div class="step">
                        <div class="step-circle">2</div>
                        <small>ë¬¸ì„œ ë¶„ì„</small>
                    </div>
                    <div class="step">
                        <div class="step-circle">3</div>
                        <small>ì •ë³´ ê²€ì¦</small>
                    </div>
                    <div class="step">
                        <div class="step-circle">4</div>
                        <small>ì™„ë£Œ</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="card" id="uploadSection">
            <div class="card-body">
                <div class="row">
                    <!-- ì—¬ê¶Œ ì—…ë¡œë“œ -->
                    <div class="col-md-4">
                        <div class="document-section">
                            <div class="document-title">
                                <i class="bi bi-airplane text-primary"></i>
                                ì—¬ê¶Œ ì—…ë¡œë“œ
                            </div>
                            <div class="upload-area" id="passportUpload">
                                <div id="passportDefault">
                                    <i class="bi bi-cloud-upload text-muted" style="font-size: 2.5rem;"></i>
                                    <h6 class="mt-2 text-muted">ì—¬ê¶Œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h6>
                                    <p class="text-muted small">ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
                                    <small class="text-muted">ì§€ì› í˜•ì‹: JPG, PNG, PDF (ìµœëŒ€ 10MB)</small>
                                </div>
                                <div id="passportPreview" style="display: none;">
                                    <img id="passportImage" class="file-preview" alt="ì—¬ê¶Œ ë¯¸ë¦¬ë³´ê¸°">
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i>
                                            <span id="passportFileName"></span>
                                        </small>
                                        <br>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFile('passport')">
                                            <i class="bi bi-trash"></i> ì œê±°
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="passportInput" accept="image/*,.pdf" style="display: none;">
                        </div>
                    </div>

                    <!-- ìš´ì „ë©´í—ˆì¦ ì—…ë¡œë“œ -->
                    <div class="col-md-4">
                        <div class="document-section">
                            <div class="document-title">
                                <i class="bi bi-car-front text-success"></i>
                                ìš´ì „ë©´í—ˆì¦ ì—…ë¡œë“œ
                            </div>
                            <div class="upload-area" id="licenseUpload">
                                <div id="licenseDefault">
                                    <i class="bi bi-cloud-upload text-muted" style="font-size: 2.5rem;"></i>
                                    <h6 class="mt-2 text-muted">ìš´ì „ë©´í—ˆì¦ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h6>
                                    <p class="text-muted small">ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
                                    <small class="text-muted">ì§€ì› í˜•ì‹: JPG, PNG, PDF (ìµœëŒ€ 10MB)</small>
                                </div>
                                <div id="licensePreview" style="display: none;">
                                    <img id="licenseImage" class="file-preview" alt="ìš´ì „ë©´í—ˆì¦ ë¯¸ë¦¬ë³´ê¸°">
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i>
                                            <span id="licenseFileName"></span>
                                        </small>
                                        <br>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFile('license')">
                                            <i class="bi bi-trash"></i> ì œê±°
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="licenseInput" accept="image/*,.pdf" style="display: none;">
                        </div>
                    </div>

                    <!-- ì…€í”¼ ì—…ë¡œë“œ â­ Phase 4 ì‹ ê·œ ì¶”ê°€ -->
                    <div class="col-md-4">
                        <div class="document-section">
                            <div class="document-title">
                                <i class="bi bi-person-circle text-warning"></i>
                                ì…€í”¼ ì—…ë¡œë“œ
                            </div>
                            <div class="upload-area" id="selfieUpload">
                                <div id="selfieDefault">
                                    <i class="bi bi-camera text-muted" style="font-size: 2.5rem;"></i>
                                    <h6 class="mt-2 text-muted">ì…€í”¼ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h6>
                                    <p class="text-muted small">ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
                                    <small class="text-muted">ì§€ì› í˜•ì‹: JPG, PNG (ìµœëŒ€ 5MB)</small>
                                </div>
                                <div id="selfiePreview" style="display: none;">
                                    <img id="selfieImage" class="file-preview" alt="ì…€í”¼ ë¯¸ë¦¬ë³´ê¸°">
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i>
                                            <span id="selfieFileName"></span>
                                        </small>
                                        <br>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFile('selfie')">
                                            <i class="bi bi-trash"></i> ì œê±°
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="selfieInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- ì²˜ë¦¬ ë²„íŠ¼ -->
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-process btn-lg" id="processBtn" disabled>
                        <i class="bi bi-gear-fill me-2"></i>
                        ë¬¸ì„œ ë¶„ì„ ì‹œì‘
                    </button>
                    <p class="text-muted small mt-2">ì„¸ ê°œì˜ íŒŒì¼ì„ ëª¨ë‘ ì—…ë¡œë“œí•œ í›„ ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>

                <!-- ì§„í–‰ë¥  í‘œì‹œ -->
                <div class="progress-container mt-4">
                    <div class="text-center mb-3">
                        <h5 id="progressTitle">ë¬¸ì„œ ë¶„ì„ ì¤‘...</h5>
                        <p class="text-muted" id="progressMessage">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì •ë³´ ê²€ì¦ ë° ìˆ˜ì • ì„¹ì…˜ -->
        <div class="card mt-4" id="verificationSection" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>
                    ì •ë³´ ê²€ì¦ ë° ìˆ˜ì •
                </h4>
                <small>AIê°€ ì¶”ì¶œí•œ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•´ì£¼ì„¸ìš”</small>
            </div>
            <div class="card-body">
                <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ ì¶”ê°€ -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="mb-3">
                            <i class="bi bi-images me-2"></i>
                            ì—…ë¡œë“œëœ ë¬¸ì„œ
                        </h5>
                        <div class="row" id="uploadedImagesPreview">
                            <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>

                <!-- ìƒë…„ì›”ì¼ ê²€ì¦ ê²°ê³¼ -->
                <div id="crossValidationAlert" class="alert alert-info" style="display: none;">
                    <h5><i class="bi bi-calendar-check me-2"></i>ìƒë…„ì›”ì¼ ê²€ì¦ ê²°ê³¼</h5>
                    <div id="validationDetails"></div>
                </div>

                <!-- KYC ì •ë³´ í¸ì§‘ í¼ -->
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">ê¸°ë³¸ ì •ë³´</h5>
                        
                        <div class="mb-3">
                            <label class="form-label">ì„±ëª… (Full Name) *</label>
                            <input type="text" class="form-control" id="fullName" required>
                            <div class="form-text">ì—¬ê¶Œ ë˜ëŠ” ìš´ì „ë©´í—ˆì¦ì— ê¸°ì¬ëœ ì„±ëª…</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ìƒë…„ì›”ì¼ (Date of Birth) *</label>
                            <input type="date" class="form-control" id="dateOfBirth" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì„±ë³„ (Gender) *</label>
                            <select class="form-select" id="gender" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="M">ë‚¨ì„± (Male)</option>
                                <option value="F">ì—¬ì„± (Female)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">êµ­ì  (Nationality) *</label>
                            <input type="text" class="form-control" id="nationality" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ë¬¸ì„œ ìœ í˜• (Type of ID) *</label>
                            <input type="text" class="form-control" id="typeOfId" value="Passport + Driver's License" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ë°œê¸‰ êµ­ê°€ (Issuing Country) *</label>
                            <input type="text" class="form-control" id="issuingCountry" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5 class="mb-3">ìƒì„¸ ì •ë³´</h5>
                        
                        <div class="mb-3">
                            <label class="form-label">ê³ ìœ  ì‹ë³„ ë²ˆí˜¸ (Unique ID Number)</label>
                            <input type="text" class="form-control" id="uniqueIdNumber">
                            <div class="form-text">ì—¬ê¶Œë²ˆí˜¸ ë˜ëŠ” ë©´í—ˆì¦ë²ˆí˜¸</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì›ë³¸ ì£¼ì†Œ (Original Address)</label>
                            <textarea class="form-control" id="originalAddress" rows="2" readonly style="background-color: #f8f9fa;"></textarea>
                            <div class="form-text">ë¬¸ì„œì—ì„œ ì¶”ì¶œëœ ì›ë³¸ ì£¼ì†Œ (ì¼ë³¸ì–´/í•œêµ­ì–´ ë“±)</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì˜ë¬¸ ì£¼ì†Œ (English Address)</label>
                            <textarea class="form-control" id="address" rows="2"></textarea>
                            <div class="form-text">ì˜ë¬¸ìœ¼ë¡œ ë²ˆì—­ëœ ì£¼ì†Œ (í¸ì§‘ ê°€ëŠ¥)</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì´ë©”ì¼ (Email)</label>
                            <input type="email" class="form-control" id="email">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ì—¬ê¶Œ ë°œê¸‰ì¼</label>
                                    <input type="date" class="form-control" id="passportIssueDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ì—¬ê¶Œ ë§Œë£Œì¼</label>
                                    <input type="date" class="form-control" id="passportExpiryDate">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ë©´í—ˆì¦ ë°œê¸‰ì¼</label>
                                    <input type="date" class="form-control" id="licenseIssueDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ë©´í—ˆì¦ ë§Œë£Œì¼</label>
                                    <input type="date" class="form-control" id="licenseExpiryDate">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì¶”ê°€ ë©”ëª¨ (Additional Notes)</label>
                            <textarea class="form-control" id="additionalNotes" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- ìƒë…„ì›”ì¼ ê²€ì¦ ì„¹ì…˜ -->
                <div id="conflictResolution" style="display: none;">
                    <hr class="my-4">
                    <h5 class="text-warning mb-3">
                        <i class="bi bi-calendar-check me-2"></i>
                        ìƒë…„ì›”ì¼ ê²€ì¦ ê²°ê³¼
                    </h5>
                    <div id="conflictList"></div>
                </div>

                <!-- ì›ë³¸ ë°ì´í„° í‘œì‹œ ì„¹ì…˜ -->
                <div class="mt-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">ì—¬ê¶Œ ì •ë³´</h6>
                            <div id="passportInfo" class="small text-muted">
                                <!-- ì—¬ê¶Œì—ì„œ ì¶”ì¶œëœ ì›ë³¸ ì •ë³´ í‘œì‹œ -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">ìš´ì „ë©´í—ˆì¦ ì •ë³´</h6>
                            <div id="licenseInfo" class="small text-muted">
                                <!-- ë©´í—ˆì¦ì—ì„œ ì¶”ì¶œëœ ì›ë³¸ ì •ë³´ í‘œì‹œ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì €ì¥ ë²„íŠ¼ -->
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-secondary me-2" onclick="goBackToUpload()">
                        <i class="bi bi-arrow-left me-2"></i>
                        ë‹¤ì‹œ ì—…ë¡œë“œ
                    </button>
                    <button type="button" class="btn btn-success btn-lg" id="saveBtn">
                        <i class="bi bi-check-circle me-2"></i>
                        ì •ë³´ í™•ì¸ ì™„ë£Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Word íŒŒì¼ ìƒì„±ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <!-- ZIP íŒŒì¼ ìƒì„±ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ â­ Phase 4 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let uploadedFiles = {
            passport: null,
            license: null,
            selfie: null  // ì…€í”¼ íŒŒì¼ ì¶”ê°€
        };

        // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload('passport');
            setupFileUpload('license');
            setupFileUpload('selfie');  // ì…€í”¼ ì—…ë¡œë“œ ì¶”ê°€
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
        function setupFileUpload(type) {
            const uploadArea = document.getElementById(type + 'Upload');
            const fileInput = document.getElementById(type + 'Input');

            // í´ë¦­ ì´ë²¤íŠ¸
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0], type);
                }
            });

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0], type);
                }
            });
        }

        // íŒŒì¼ ì²˜ë¦¬
        function handleFile(file, type) {
            // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                Swal.fire({
                    icon: 'error',
                    title: 'íŒŒì¼ í¬ê¸° ì´ˆê³¼',
                    text: 'íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.',
                });
                return;
            }

            // íŒŒì¼ í˜•ì‹ ì²´í¬
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                Swal.fire({
                    icon: 'error',
                    title: 'ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹',
                    text: 'JPG, PNG, PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
                });
                return;
            }

            uploadedFiles[type] = file;
            showFilePreview(file, type);
            checkBothFilesUploaded();
        }

        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function showFilePreview(file, type) {
            const defaultDiv = document.getElementById(type + 'Default');
            const previewDiv = document.getElementById(type + 'Preview');
            const imageElement = document.getElementById(type + 'Image');
            const fileNameSpan = document.getElementById(type + 'FileName');

            defaultDiv.style.display = 'none';
            previewDiv.style.display = 'block';
            fileNameSpan.textContent = file.name;

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageElement.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                // PDFì˜ ê²½ìš° ì•„ì´ì½˜ í‘œì‹œ
                imageElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNkYzM1NDUiLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5QREY8L3RleHQ+PC9zdmc+';
            }
        }

        // íŒŒì¼ ì œê±°
        function removeFile(type) {
            uploadedFiles[type] = null;
            
            const defaultDiv = document.getElementById(type + 'Default');
            const previewDiv = document.getElementById(type + 'Preview');
            const fileInput = document.getElementById(type + 'Input');

            defaultDiv.style.display = 'block';
            previewDiv.style.display = 'none';
            fileInput.value = '';

            checkBothFilesUploaded();
        }

        // ë‘ íŒŒì¼ ëª¨ë‘ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ ì²´í¬
        function checkBothFilesUploaded() {
            const processBtn = document.getElementById('processBtn');
            
            if (uploadedFiles.passport && uploadedFiles.license && uploadedFiles.selfie) {
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="bi bi-gear-fill me-2"></i>ë¬¸ì„œ ë¶„ì„ ì‹œì‘';
            } else {
                processBtn.disabled = true;
                processBtn.innerHTML = '<i class="bi bi-gear-fill me-2"></i>ë¬¸ì„œ ë¶„ì„ ì‹œì‘';
            }
        }

        // ë¬¸ì„œ ì²˜ë¦¬ ì‹œì‘
        document.getElementById('processBtn').addEventListener('click', function() {
            if (!uploadedFiles.passport || !uploadedFiles.license || !uploadedFiles.selfie) {
                Swal.fire({
                    icon: 'warning',
                    title: 'íŒŒì¼ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”',
                    text: 'ì—¬ê¶Œ, ìš´ì „ë©´í—ˆì¦, ì…€í”¼ íŒŒì¼ì„ ëª¨ë‘ ì—…ë¡œë“œí•œ í›„ ì§„í–‰í•´ì£¼ì„¸ìš”.',
                });
                return;
            }

            startDocumentProcessing();
        });

        // ë¬¸ì„œ ì²˜ë¦¬ ì‹œì‘
        async function startDocumentProcessing() {
            try {
                // UI ì—…ë°ì´íŠ¸
                document.querySelector('.progress-container').style.display = 'block';
                document.getElementById('processBtn').disabled = true;
                updateStep(2);
                updateProgress(10, 'íŒŒì¼ ì¤€ë¹„ ì¤‘...');

                // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜ (data:image/jpeg;base64, ì œê±°)
                const passportBase64 = await fileToBase64(uploadedFiles.passport);
                const licenseBase64 = await fileToBase64(uploadedFiles.license);

                // Base64 í—¤ë” ì œê±°
                const passportData = passportBase64.split(',')[1];
                const licenseData = licenseBase64.split(',')[1];

                updateProgress(30, 'Firebase ì„œë²„ì— ì „ì†¡ ì¤‘...');

                // API í˜¸ì¶œ ë°ì´í„° ì¤€ë¹„ (ì˜¬ë°”ë¥¸ í‚¤ ì´ë¦„ ì‚¬ìš©)
                const requestData = {
                    passportImage: passportData,
                    licenseImage: licenseData
                };

                console.log('ìš”ì²­ ë°ì´í„° í¬ê¸°:', {
                    passport: passportData.length,
                    license: licenseData.length
                });

                updateProgress(50, 'ë¬¸ì„œ ë¶„ì„ ì¤‘...');

                // Firebase Functions API í˜¸ì¶œ
                const response = await fetch('https://us-central1-kyc-document-generator.cloudfunctions.net/processMultipleDocuments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                updateProgress(80, 'ê²°ê³¼ ì²˜ë¦¬ ì¤‘...');

                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ì„œë²„ ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                
                // API ì‘ë‹µ ìƒì„¸ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                console.log('=== API ì‘ë‹µ ì „ì²´ ë””ë²„ê¹… ===');
                console.log('Success:', result.success);
                console.log('Message:', result.message);
                console.log('ì—¬ê¶Œ ì›ë³¸ ë°ì´í„°:', result.passport_data?.original);
                console.log('ì—¬ê¶Œ ë²ˆì—­ ë°ì´í„°:', result.passport_data?.translated);
                console.log('ë©´í—ˆì¦ ì›ë³¸ ë°ì´í„°:', result.license_data?.original);
                console.log('ë©´í—ˆì¦ ë²ˆì—­ ë°ì´í„°:', result.license_data?.translated);
                console.log('êµì°¨ ê²€ì¦:', result.cross_validation);
                console.log('KYC í•„ë“œ:', result.kyc_fields);
                console.log('=== API ì‘ë‹µ ë””ë²„ê¹… ì™„ë£Œ ===');
                
                updateProgress(100, 'ì™„ë£Œ!');

                if (result.success) {
                    // ì„±ê³µì‹œ ê²€ì¦ í˜ì´ì§€ë¡œ ì´ë™
                    setTimeout(() => {
                        showVerificationPage(result);
                    }, 1000);
                } else {
                    throw new Error(result.message || 'ë¬¸ì„œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ì²˜ë¦¬ ì‹¤íŒ¨',
                    text: error.message || 'ë¬¸ì„œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                });
                
                // UI ë¦¬ì…‹
                document.querySelector('.progress-container').style.display = 'none';
                document.getElementById('processBtn').disabled = false;
                updateStep(1);
            }
        }

        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percentage, message) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressMessage').textContent = message;
        }

        // ë‹¨ê³„ ì—…ë°ì´íŠ¸
        function updateStep(stepNumber) {
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepCircle = step.querySelector('.step-circle');
                
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
        }

        // ê²€ì¦ í˜ì´ì§€ í‘œì‹œ (ì—…ë¡œë“œ ì´ë¯¸ì§€ ìœ ì§€) - UI/UX ê°œì„ 
        async function showVerificationPage(result) {
            // ì—…ë¡œë“œ ì„¹ì…˜ ìœ ì§€, ê²€ì¦ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('verificationSection').style.display = 'block';
            
            // ì—…ë¡œë“œ ì„¹ì…˜ì˜ ì²˜ë¦¬ ë²„íŠ¼ê³¼ ì§„í–‰ë¥  ìˆ¨ê¸°ê¸°
            document.getElementById('processBtn').style.display = 'none';
            document.querySelector('.progress-container').style.display = 'none';
            
            // ì—…ë¡œë“œ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™” (ì¶”ê°€ ì—…ë¡œë“œ ë°©ì§€)
            const uploadAreas = document.querySelectorAll('.upload-area');
            uploadAreas.forEach(area => {
                area.style.pointerEvents = 'none';
                area.style.opacity = '0.7';
            });
            
            // ë‹¨ê³„ ì—…ë°ì´íŠ¸
            updateStep(3);
            
            // ì „ì—­ ë³€ìˆ˜ì— ê²°ê³¼ ì €ì¥
            window.apiResult = result;
            
            console.log('=== showVerificationPage ì‹œì‘ ===');
            console.log('í˜ì´ì§€ ì „í™˜ ì™„ë£Œ, ë°ì´í„° ì±„ìš°ê¸° ì‹œì‘...');
            
            // DOM ë Œë”ë§ ì™„ë£Œë¥¼ ìœ„í•œ ì§€ì—° ì‹œê°„ ì¦ê°€
            setTimeout(() => {
                console.log('ì²« ë²ˆì§¸ ë°ì´í„° ì±„ìš°ê¸° ì‹œë„...');
                populateKYCFields(result);
                showOriginalData(result);
                showUploadedImages(); // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ í‘œì‹œ ì¶”ê°€
                
                // ì¶”ê°€ ê²€ì¦ ë° ì¬ì‹œë„ (ì§€ì—° ì‹œê°„ ì¦ê°€)
                setTimeout(() => {
                    console.log('ê°•ì œ ê²€ì¦ ë° ì¬ì‹œë„...');
                    verifyDataPopulation(result);
                    
                    // ìµœì¢… í™•ì¸ ë° ê°•ì œ ì„¤ì •
                    setTimeout(async () => {
                        console.log('ìµœì¢… ê°•ì œ ì„¤ì • ì‹œë„...');
                        await forcePopulateFields(result);
                        
                        // ë°ì´í„° ì„¤ì • ì™„ë£Œ í›„ ê²€ì¦ ì‹¤í–‰
                        setTimeout(() => {
                            console.log('ğŸ” ë°ì´í„° ì„¤ì • ì™„ë£Œ í›„ ê²€ì¦ ì‹¤í–‰...');
                            showCrossValidation(result);
                        }, 500);
                    }, 1000);
                }, 1000);
            }, 500);
        }

        // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë“¤ì„ ê²€ì¦ í˜ì´ì§€ì— í‘œì‹œ
        function showUploadedImages() {
            const previewContainer = document.getElementById('uploadedImagesPreview');
            let html = '';
            
            // ì—…ë¡œë“œëœ íŒŒì¼ë“¤ í™•ì¸
            const fileTypes = [
                { key: 'passport', label: 'ì—¬ê¶Œ', icon: 'bi-pass', color: 'primary' },
                { key: 'license', label: 'ìš´ì „ë©´í—ˆì¦', icon: 'bi-credit-card-2-front', color: 'success' },
                { key: 'selfie', label: 'ì…€í”¼', icon: 'bi-person-circle', color: 'warning' }
            ];
            
            fileTypes.forEach(type => {
                if (uploadedFiles[type.key]) {
                    const file = uploadedFiles[type.key];
                    const imageUrl = URL.createObjectURL(file);
                    
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card border-${type.color}">
                                <div class="card-header bg-${type.color} text-white text-center">
                                    <i class="${type.icon} me-2"></i>
                                    ${type.label}
                                </div>
                                <div class="card-body p-2">
                                    <img src="${imageUrl}" class="img-fluid rounded" 
                                         style="width: 100%; height: 200px; object-fit: cover;" 
                                         alt="${type.label}">
                                    <div class="text-center mt-2">
                                        <small class="text-muted">${file.name}</small><br>
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i> 
                                            ì—…ë¡œë“œ ì™„ë£Œ
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html) {
                previewContainer.innerHTML = html;
            } else {
                previewContainer.innerHTML = '<div class="col-12 text-center text-muted">ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ê°•ì œ í•„ë“œ ì±„ìš°ê¸° í•¨ìˆ˜ (ë²ˆì—­ ê¸°ëŠ¥ í¬í•¨)
        async function forcePopulateFields(result) {
            console.log('=== forcePopulateFields ì‹œì‘ ===');
            
            // ëª¨ë“  ë°ì´í„° ì†ŒìŠ¤ì—ì„œ ê°’ ì¶”ì¶œ (ë²ˆì—­ í¬í•¨)
            const allData = await extractAllPossibleData(result);
            console.log('ì¶”ì¶œëœ ëª¨ë“  ë°ì´í„°:', allData);
            
            // ê°•ì œë¡œ ëª¨ë“  í•„ë“œ ì„¤ì •
            const fieldIds = ['fullName', 'dateOfBirth', 'gender', 'nationality', 'issuingCountry', 'uniqueIdNumber', 'originalAddress', 'address', 'email'];
            
            fieldIds.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                const value = allData[fieldId] || '';
                
                if (element) {
                    // ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ê°’ ì„¤ì • ì‹œë„
                    element.value = value;
                    element.setAttribute('value', value);
                    
                    // ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                    element.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    console.log(`ğŸ”§ ê°•ì œ ì„¤ì •: ${fieldId} = "${value}" (ì„±ê³µ: ${element.value === value})`);
                } else {
                    console.log(`âŒ ìš”ì†Œ ì—†ìŒ: ${fieldId}`);
                }
            });
            
            // ë‚ ì§œ í•„ë“œ ê°•ì œ ì„¤ì •
            const dateFields = {
                'passportIssueDate': allData.passportIssueDate,
                'passportExpiryDate': allData.passportExpiryDate,
                'licenseIssueDate': allData.licenseIssueDate,
                'licenseExpiryDate': allData.licenseExpiryDate
            };
            
            Object.entries(dateFields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element && value) {
                    element.value = value;
                    console.log(`ğŸ“… ë‚ ì§œ ê°•ì œ ì„¤ì •: ${fieldId} = "${value}"`);
                }
            });
            
            // ì¶”ê°€ ë©”ëª¨ ì„¤ì •
            const notesField = document.getElementById('additionalNotes');
            if (notesField) {
                notesField.value = 'ë¬¸ì„œì—ì„œ ìë™ ì¶”ì¶œë¨ (ê°•ì œ ì„¤ì •)';
            }
            
            console.log('=== forcePopulateFields ì™„ë£Œ ===');
        }

        // ì£¼ì†Œ ë²ˆì—­ í•¨ìˆ˜
        async function translateToEnglish(japaneseAddress) {
            if (!japaneseAddress || japaneseAddress.trim() === '') {
                console.log('ğŸ“ ë²ˆì—­í•  ì£¼ì†Œê°€ ì—†ìŒ');
                return '';
            }
            
            console.log('ğŸŒ ì£¼ì†Œ ë²ˆì—­ ì‹œì‘:', japaneseAddress);
            
            try {
                const response = await fetch('https://us-central1-kyc-document-generator.cloudfunctions.net/translateAddress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: japaneseAddress,
                        sourceLang: 'ja',
                        targetLang: 'en'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.translatedText) {
                    console.log('âœ… ì£¼ì†Œ ë²ˆì—­ ì„±ê³µ:', result.translatedText);
                    return result.translatedText;
                } else {
                    console.log('âŒ ì£¼ì†Œ ë²ˆì—­ ì‹¤íŒ¨:', result);
                    return japaneseAddress; // ë²ˆì—­ ì‹¤íŒ¨ì‹œ ì›ë³¸ ë°˜í™˜
                }
            } catch (error) {
                console.error('ğŸš¨ ì£¼ì†Œ ë²ˆì—­ ì˜¤ë¥˜:', error);
                return japaneseAddress; // ì˜¤ë¥˜ì‹œ ì›ë³¸ ë°˜í™˜
            }
        }

        // ëª¨ë“  ê°€ëŠ¥í•œ ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜ (ë²ˆì—­ ê¸°ëŠ¥ í¬í•¨)
        async function extractAllPossibleData(result) {
            const passport = result.passport_data || {};
            const license = result.license_data || {};
            const kyc = result.kyc_fields || {};
            
            // ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ” ìœ„ì¹˜ì—ì„œ ì¶”ì¶œ
            const passportOriginalData = passport.original?.data || {};
            const passportTranslatedData = passport.translated?.data || {};
            const licenseOriginalData = license.original?.data || {};
            const licenseTranslatedData = license.translated?.data || {};
            
            console.log('=== ë°ì´í„° ì¶”ì¶œ ë””ë²„ê¹… ===');
            console.log('passport.original:', passport.original);
            console.log('passport.translated:', passport.translated);
            console.log('license.original:', license.original);
            console.log('license.translated:', license.translated);
            console.log('ì—¬ê¶Œ ì›ë³¸ ë°ì´í„°:', passportOriginalData);
            console.log('ì—¬ê¶Œ ë²ˆì—­ ë°ì´í„°:', passportTranslatedData);
            console.log('ë©´í—ˆì¦ ì›ë³¸ ë°ì´í„°:', licenseOriginalData);
            console.log('ë©´í—ˆì¦ ë²ˆì—­ ë°ì´í„°:', licenseTranslatedData);
            
            // ì£¼ì†Œ ë°ì´í„° íŠ¹ë³„ ë””ë²„ê¹…
            console.log('=== ì£¼ì†Œ ë°ì´í„° ìƒì„¸ ë””ë²„ê¹… ===');
            console.log('ë©´í—ˆì¦ ì›ë³¸ address1:', licenseOriginalData.address1);
            console.log('ë©´í—ˆì¦ ë²ˆì—­ address1:', licenseTranslatedData.address1);
            console.log('ë©´í—ˆì¦ ì›ë³¸ address:', licenseOriginalData.address);
            console.log('ë©´í—ˆì¦ ë²ˆì—­ address:', licenseTranslatedData.address);
            console.log('ë©´í—ˆì¦ ë²ˆì—­ ë°ì´í„°:', licenseTranslatedData);
            
            // ë°ì´í„° ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
            const getValue = (data, keys) => {
                // ë¨¼ì € data ê°ì²´ ì•ˆì— ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (data && data.data) {
                    const actualData = data.data;
                    for (const key of keys) {
                        if (actualData[key]) {
                            // ë°°ì—´ì¸ ê²½ìš° ì²« ë²ˆì§¸ ê°’ì˜ value ì†ì„± ê°€ì ¸ì˜¤ê¸°
                            if (Array.isArray(actualData[key]) && actualData[key].length > 0) {
                                const item = actualData[key][0];
                                // value ì†ì„±ì´ ìˆìœ¼ë©´ ë°˜í™˜
                                if (item && typeof item === 'object' && item.value !== undefined) {
                                    return item.value;
                                }
                                // value ì†ì„±ì´ ì—†ìœ¼ë©´ item ìì²´ ë°˜í™˜
                                return item;
                            }
                            // ê°ì²´ì¸ ê²½ìš° value ì†ì„± ê°€ì ¸ì˜¤ê¸°
                            if (typeof actualData[key] === 'object' && actualData[key].value !== undefined) {
                                return actualData[key].value;
                            }
                            // ë¬¸ìì—´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
                            if (typeof actualData[key] === 'string') {
                                return actualData[key];
                            }
                        }
                    }
                }
                
                // data.dataê°€ ì—†ëŠ” ê²½ìš° ì§ì ‘ dataì—ì„œ í™•ì¸
                for (const key of keys) {
                    if (data[key]) {
                        // ë°°ì—´ì¸ ê²½ìš° ì²« ë²ˆì§¸ ê°’ì˜ value ì†ì„± ê°€ì ¸ì˜¤ê¸°
                        if (Array.isArray(data[key]) && data[key].length > 0) {
                            const item = data[key][0];
                            // value ì†ì„±ì´ ìˆìœ¼ë©´ ë°˜í™˜
                            if (item && typeof item === 'object' && item.value !== undefined) {
                                return item.value;
                            }
                            // value ì†ì„±ì´ ì—†ìœ¼ë©´ item ìì²´ ë°˜í™˜
                            return item;
                        }
                        // ê°ì²´ì¸ ê²½ìš° value ì†ì„± ê°€ì ¸ì˜¤ê¸°
                        if (typeof data[key] === 'object' && data[key].value !== undefined) {
                            return data[key].value;
                        }
                        // ë¬¸ìì—´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
                        if (typeof data[key] === 'string') {
                            return data[key];
                        }
                    }
                }
                return '';
            };
            
            // ì£¼ì†Œ ì¶”ì¶œ í•¨ìˆ˜ (ë””ë²„ê¹… ê°•í™”)
            const getAddressValue = (data, keys, dataSource) => {
                console.log(`ğŸ” ì£¼ì†Œ ì¶”ì¶œ ì‹œë„ (${dataSource}):`, data);
                for (const key of keys) {
                    if (data[key]) {
                        console.log(`  - ${key} í•„ë“œ ë°œê²¬:`, data[key]);
                        // ë°°ì—´ì¸ ê²½ìš° ì²« ë²ˆì§¸ ê°’ì˜ value ì†ì„± ê°€ì ¸ì˜¤ê¸°
                        if (Array.isArray(data[key]) && data[key].length > 0) {
                            const item = data[key][0];
                            console.log(`    ë°°ì—´ ì²« ë²ˆì§¸ ì•„ì´í…œ:`, item);
                            // value ì†ì„±ì´ ìˆìœ¼ë©´ ë°˜í™˜
                            if (item && typeof item === 'object' && item.value !== undefined) {
                                console.log(`    âœ… ì£¼ì†Œ ë°œê²¬ (${dataSource}/${key}):`, item.value);
                                return item.value;
                            }
                            // value ì†ì„±ì´ ì—†ìœ¼ë©´ item ìì²´ ë°˜í™˜
                            if (item) {
                                console.log(`    âœ… ì£¼ì†Œ ë°œê²¬ (${dataSource}/${key}):`, item);
                                return item;
                            }
                        }
                        // ê°ì²´ì¸ ê²½ìš° value ì†ì„± ê°€ì ¸ì˜¤ê¸°
                        if (typeof data[key] === 'object' && data[key].value !== undefined) {
                            console.log(`    âœ… ì£¼ì†Œ ë°œê²¬ (${dataSource}/${key}):`, data[key].value);
                            return data[key].value;
                        }
                        // ë¬¸ìì—´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
                        if (typeof data[key] === 'string') {
                            console.log(`    âœ… ì£¼ì†Œ ë°œê²¬ (${dataSource}/${key}):`, data[key]);
                            return data[key];
                        }
                    }
                }
                console.log(`  âŒ ${dataSource}ì—ì„œ ì£¼ì†Œ ë¯¸ë°œê²¬`);
                return '';
            };
            
            // ì¼ë³¸ ì—¬ê¶Œ/ë©´í—ˆì¦ì˜ ì‹¤ì œ í•„ë“œëª…ì— ë§ì¶° ë°ì´í„° ì¶”ì¶œ
            const extractedData = {
                fullName: kyc.full_name || 
                         getValue(passportTranslatedData, ['documentName', 'fullName', 'name', 'firstName', 'lastName']) ||
                         getValue(passportOriginalData, ['documentName', 'fullName', 'name', 'firstName', 'lastName']) ||
                         getValue(licenseTranslatedData, ['documentName', 'fullName', 'name']) ||
                         getValue(licenseOriginalData, ['documentName', 'fullName', 'name']) || '',
                         
                dateOfBirth: kyc.date_of_birth || 
                            getValue(passportTranslatedData, ['dateOfBirth', 'birthDate', 'dob']) ||
                            getValue(passportOriginalData, ['dateOfBirth', 'birthDate', 'dob']) ||
                            getValue(licenseTranslatedData, ['dateOfBirth', 'birthDate', 'dob']) ||
                            getValue(licenseOriginalData, ['dateOfBirth', 'birthDate', 'dob']) || '',
                            
                gender: kyc.gender || 
                       getValue(passportTranslatedData, ['sex', 'gender']) ||
                       getValue(passportOriginalData, ['sex', 'gender']) ||
                       getValue(licenseTranslatedData, ['sex', 'gender']) ||
                       getValue(licenseOriginalData, ['sex', 'gender']) || '',
                       
                nationality: kyc.nationality || 
                            getValue(passportTranslatedData, ['nationality', 'countryFull', 'country']) ||
                            getValue(passportOriginalData, ['nationality', 'countryFull', 'country']) ||
                            getValue(licenseTranslatedData, ['nationality', 'countryFull', 'country']) ||
                            getValue(licenseOriginalData, ['nationality', 'countryFull', 'country']) || '',
                            
                issuingCountry: kyc.issuing_country || 
                               getValue(passportTranslatedData, ['issuingCountry', 'countryFull', 'country']) ||
                               getValue(passportOriginalData, ['issuingCountry', 'countryFull', 'country']) ||
                               getValue(licenseTranslatedData, ['issuingCountry', 'countryFull', 'country']) ||
                               getValue(licenseOriginalData, ['issuingCountry', 'countryFull', 'country']) || '',
                               
                uniqueIdNumber: '', // SMBì—ì„œ ë³„ë„ ë¶€ì—¬í•˜ëŠ” ë²ˆí˜¸ì´ë¯€ë¡œ ê³µë€ ì²˜ë¦¬
                               
                originalAddress: getAddressValue(licenseOriginalData, ['address1', 'address', 'fullAddress', 'addr'], 'ë©´í—ˆì¦ì›ë³¸') ||
                                getAddressValue(licenseTranslatedData, ['address1', 'address', 'fullAddress', 'addr'], 'ë©´í—ˆì¦ë²ˆì—­') ||
                                getAddressValue(passportOriginalData, ['address1', 'address', 'fullAddress', 'addr'], 'ì—¬ê¶Œì›ë³¸') ||
                                getAddressValue(passportTranslatedData, ['address1', 'address', 'fullAddress', 'addr'], 'ì—¬ê¶Œë²ˆì—­') || '',
                                
                address: await translateToEnglish(
                        getAddressValue(licenseTranslatedData, ['address1', 'address', 'fullAddress', 'addr'], 'ë©´í—ˆì¦ë²ˆì—­') ||
                        getAddressValue(licenseOriginalData, ['address1', 'address', 'fullAddress', 'addr'], 'ë©´í—ˆì¦ì›ë³¸') ||
                        getAddressValue(passportTranslatedData, ['address1', 'address', 'fullAddress', 'addr'], 'ì—¬ê¶Œë²ˆì—­') ||
                        getAddressValue(passportOriginalData, ['address1', 'address', 'fullAddress', 'addr'], 'ì—¬ê¶Œì›ë³¸') ||
                        kyc.address || ''
                    ),
                        
                email: kyc.email || '',
                
                passportIssueDate: getValue(passportTranslatedData, ['dateOfIssue', 'issueDate', 'issued']) ||
                                  getValue(passportOriginalData, ['dateOfIssue', 'issueDate', 'issued']) || '',
                                  
                passportExpiryDate: getValue(passportTranslatedData, ['dateOfExpiry', 'expiryDate', 'expiry']) ||
                                   getValue(passportOriginalData, ['dateOfExpiry', 'expiryDate', 'expiry']) || '',
                                   
                licenseIssueDate: getValue(licenseTranslatedData, ['dateOfIssue', 'issueDate', 'issued']) ||
                                 getValue(licenseOriginalData, ['dateOfIssue', 'issueDate', 'issued']) || '',
                                 
                licenseExpiryDate: getValue(licenseTranslatedData, ['dateOfExpiry', 'expiryDate', 'expiry']) ||
                                  getValue(licenseOriginalData, ['dateOfExpiry', 'expiryDate', 'expiry']) || ''
            };
            
            console.log('=== ìµœì¢… ì¶”ì¶œëœ ë°ì´í„° ===', extractedData);
            return extractedData;
        }

        // ë°ì´í„° ì±„ìš°ê¸° ê²€ì¦ ë° ì¬ì‹œë„
        function verifyDataPopulation(result) {
            console.log('=== verifyDataPopulation ì‹œì‘ ===');
            console.log('ì „ì²´ ê²°ê³¼ ë°ì´í„°:', result);
            
            const fullNameField = document.getElementById('fullName');
            console.log('fullName í•„ë“œ:', fullNameField);
            console.log('í˜„ì¬ fullName ê°’:', fullNameField ? fullNameField.value : 'null');
            
            if (!fullNameField || !fullNameField.value) {
                console.log('ë°ì´í„° ì±„ìš°ê¸° ì‹¤íŒ¨ - ê°•ì œ ì¬ì‹œë„ ì¤‘...');
                
                // ëª¨ë“  ê°€ëŠ¥í•œ ë°ì´í„° ì†ŒìŠ¤ í™•ì¸
                const passportData = result.passport_data?.translated || result.passport_data?.original || {};
                const licenseData = result.license_data?.translated || result.license_data?.original || {};
                const kycFields = result.kyc_fields || {};
                
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„° ì†ŒìŠ¤:');
                console.log('- ì—¬ê¶Œ ë²ˆì—­ ë°ì´í„°:', passportData);
                console.log('- ë©´í—ˆì¦ ë²ˆì—­ ë°ì´í„°:', licenseData);
                console.log('- KYC í•„ë“œ:', kycFields);
                
                // ê°•ì œ ë°ì´í„° ë§¤í•‘ (ëª¨ë“  ê°€ëŠ¥í•œ í•„ë“œì—ì„œ ì¶”ì¶œ)
                const extractedData = {
                    fullName: kycFields.full_name || passportData.documentName || passportData.name || licenseData.documentName || licenseData.name || '',
                    dateOfBirth: kycFields.date_of_birth || passportData.dateOfBirth || passportData.birthDate || licenseData.dateOfBirth || licenseData.birthDate || '',
                    gender: kycFields.gender || passportData.sex || passportData.gender || licenseData.sex || licenseData.gender || '',
                    nationality: kycFields.nationality || passportData.nationality || passportData.country || licenseData.nationality || licenseData.country || '',
                    issuingCountry: kycFields.issuing_country || passportData.nationality || passportData.country || licenseData.nationality || licenseData.country || '',
                    uniqueIdNumber: kycFields.unique_identification_number || passportData.documentNumber || passportData.number || licenseData.documentNumber || licenseData.number || '',
                    originalAddress: licenseData.address || passportData.address || '',
                    address: translateAddress(licenseData.address || passportData.address) || ''
                };
                
                console.log('ì¶”ì¶œëœ ë°ì´í„°:', extractedData);
                
                // DOM ìš”ì†Œ ê°•ì œ ì„¤ì •
                const fieldMappings = [
                    { id: 'fullName', value: extractedData.fullName },
                    { id: 'dateOfBirth', value: extractedData.dateOfBirth },
                    { id: 'gender', value: extractedData.gender },
                    { id: 'nationality', value: extractedData.nationality },
                    { id: 'issuingCountry', value: extractedData.issuingCountry },
                    { id: 'uniqueIdNumber', value: extractedData.uniqueIdNumber },
                    { id: 'originalAddress', value: extractedData.originalAddress },
                    { id: 'address', value: extractedData.address }
                ];
                
                fieldMappings.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element && field.value) {
                        element.value = field.value;
                        console.log(`âœ… ì„¤ì • ì„±ê³µ: ${field.id} = ${field.value}`);
                    } else {
                        console.log(`âŒ ì„¤ì • ì‹¤íŒ¨: ${field.id} (ìš”ì†Œ: ${!!element}, ê°’: ${field.value})`);
                    }
                });
                
                // ë‚ ì§œ í•„ë“œ ë³„ë„ ì²˜ë¦¬
                const dateFields = [
                    { id: 'passportIssueDate', value: passportData.dateOfIssue || passportData.issueDate || '' },
                    { id: 'passportExpiryDate', value: passportData.dateOfExpiry || passportData.expiryDate || '' },
                    { id: 'licenseIssueDate', value: licenseData.dateOfIssue || licenseData.issueDate || '' },
                    { id: 'licenseExpiryDate', value: licenseData.dateOfExpiry || licenseData.expiryDate || '' }
                ];
                
                dateFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element && field.value) {
                        element.value = field.value;
                        console.log(`ğŸ“… ë‚ ì§œ ì„¤ì •: ${field.id} = ${field.value}`);
                    }
                });
                
                // ì¶”ê°€ ë©”ëª¨ ì„¤ì •
                const additionalNotesField = document.getElementById('additionalNotes');
                if (additionalNotesField) {
                    additionalNotesField.value = kycFields.additional_notes || 'ë¬¸ì„œì—ì„œ ìë™ ì¶”ì¶œë¨ (ê°•ì œ ë§¤í•‘)';
                }
                
                console.log('=== ê°•ì œ ë°ì´í„° ì„¤ì • ì™„ë£Œ ===');
            } else {
                console.log('ë°ì´í„° ì±„ìš°ê¸° ì •ìƒ ì™„ë£Œ');
            }
        }

        // KYC í•„ë“œ ìë™ ì±„ìš°ê¸°
        function populateKYCFields(result) {
            console.log('=== populateKYCFields ë””ë²„ê¹… ì‹œì‘ ===');
            console.log('ì „ì²´ API ì‘ë‹µ êµ¬ì¡°:', JSON.stringify(result, null, 2));
            console.log('passport_data ë‚´ìš©:', result.passport_data);
            console.log('license_data ë‚´ìš©:', result.license_data);
            
            // API ì‘ë‹µì—ì„œ ì‹¤ì œ ë°ì´í„° ìœ„ì¹˜ í™•ì¸
            let passportData = null;
            let licenseData = null;
            
            // passport_data í™•ì¸
            if (result.passport_data) {
                if (result.passport_data.kyc_fields) {
                    passportData = result.passport_data.kyc_fields;
                    console.log('ì—¬ê¶Œ KYC í•„ë“œ ë°œê²¬:', passportData);
                } else if (result.passport_data.translated) {
                    passportData = result.passport_data.translated;
                    console.log('ì—¬ê¶Œ ë²ˆì—­ ë°ì´í„° ë°œê²¬:', passportData);
                } else if (result.passport_data.original) {
                    passportData = result.passport_data.original;
                    console.log('ì—¬ê¶Œ ì›ë³¸ ë°ì´í„° ë°œê²¬:', passportData);
                }
            }
            
            // license_data í™•ì¸
            if (result.license_data) {
                if (result.license_data.kyc_fields) {
                    licenseData = result.license_data.kyc_fields;
                    console.log('ë©´í—ˆì¦ KYC í•„ë“œ ë°œê²¬:', licenseData);
                } else if (result.license_data.translated) {
                    licenseData = result.license_data.translated;
                    console.log('ë©´í—ˆì¦ ë²ˆì—­ ë°ì´í„° ë°œê²¬:', licenseData);
                } else if (result.license_data.original) {
                    licenseData = result.license_data.original;
                    console.log('ë©´í—ˆì¦ ì›ë³¸ ë°ì´í„° ë°œê²¬:', licenseData);
                }
            }
            
            // kyc_fieldsê°€ ìµœìƒìœ„ì— ìˆëŠ” ê²½ìš°
            const kycFields = result.kyc_fields || {};
            console.log('ìµœìƒìœ„ KYC í•„ë“œ:', kycFields);
            
            // ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ ë°ì´í„° ë§¤í•‘
            const finalData = {
                fullName: kycFields.full_name || 
                         passportData?.documentName || passportData?.full_name ||
                         licenseData?.documentName || licenseData?.full_name || '',
                         
                dateOfBirth: kycFields.date_of_birth || 
                            passportData?.dateOfBirth || passportData?.date_of_birth ||
                            licenseData?.dateOfBirth || licenseData?.date_of_birth || '',
                            
                gender: kycFields.gender || 
                       passportData?.sex || passportData?.gender ||
                       licenseData?.sex || licenseData?.gender || '',
                       
                nationality: kycFields.nationality || 
                            passportData?.nationality ||
                            licenseData?.nationality || '',
                            
                issuingCountry: kycFields.issuing_country || 
                               passportData?.nationality || passportData?.issuing_country ||
                               licenseData?.nationality || licenseData?.issuing_country || '',
                               
                uniqueIdNumber: kycFields.unique_identification_number || 
                               passportData?.documentNumber || passportData?.unique_identification_number ||
                               licenseData?.documentNumber || licenseData?.unique_identification_number || '',
                               
                address: kycFields.address || 
                        licenseData?.address ||
                        passportData?.address || '',
                        
                email: kycFields.email || ''
            };
            
            console.log('ìµœì¢… ë§¤í•‘ ë°ì´í„°:', finalData);
            
            // DOM ìš”ì†Œì— ê°’ ì„¤ì • - ì—¬ëŸ¬ ë°©ë²• ì‹œë„
            const mappings = [
                { fieldId: 'fullName', value: finalData.fullName },
                { fieldId: 'dateOfBirth', value: finalData.dateOfBirth },
                { fieldId: 'gender', value: finalData.gender },
                { fieldId: 'nationality', value: finalData.nationality },
                { fieldId: 'issuingCountry', value: finalData.issuingCountry },
                { fieldId: 'uniqueIdNumber', value: finalData.uniqueIdNumber },
                { fieldId: 'address', value: finalData.address },
                { fieldId: 'email', value: finalData.email }
            ];
            
            // íƒ€ì´ë° ì´ìŠˆ í•´ê²°ì„ ìœ„í•œ ì§€ì—° ì‹¤í–‰
            setTimeout(() => {
                mappings.forEach(mapping => {
                    const element = document.getElementById(mapping.fieldId);
                    if (element && mapping.value) {
                        // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ê°’ ì„¤ì • ì‹œë„
                        element.value = mapping.value;
                        element.setAttribute('value', mapping.value);
                        element.defaultValue = mapping.value;
                        
                        // ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                        element.dispatchEvent(new Event('input', { bubbles: true }));
                        element.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        console.log(`âœ… ${mapping.fieldId} ì„¤ì • ì™„ë£Œ: "${mapping.value}"`);
                    } else if (!element) {
                        console.log(`âŒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${mapping.fieldId}`);
                    } else {
                        console.log(`âš ï¸ ${mapping.fieldId}ì˜ ê°’ì´ ë¹„ì–´ìˆìŒ`);
                    }
                });
                
                // ì›ë³¸ ì£¼ì†Œ ì„¤ì • (ì½ê¸° ì „ìš©)
                const originalAddressField = document.getElementById('originalAddress');
                if (originalAddressField) {
                    const originalAddr = licenseData?.address || passportData?.address || '';
                    originalAddressField.value = originalAddr;
                    console.log(`ğŸ“ ì›ë³¸ ì£¼ì†Œ: "${originalAddr}"`);
                }
            }, 500);
            
            // ì¶”ê°€ ì§€ì—° ì‹¤í–‰ - ë” í™•ì‹¤í•˜ê²Œ ê°’ ì„¤ì •
            setTimeout(() => {
                console.log('=== 2ì°¨ ê°’ ì„¤ì • ì‹œë„ ===');
                
                // ì§ì ‘ì ì¸ DOM ì¡°ì‘
                if (finalData.fullName) {
                    const nameField = document.getElementById('fullName');
                    if (nameField) {
                        nameField.value = finalData.fullName;
                        nameField.innerHTML = finalData.fullName;
                        console.log(`ğŸ”„ fullName ì¬ì„¤ì •: "${finalData.fullName}"`);
                    }
                }
                
                if (finalData.dateOfBirth) {
                    const dobField = document.getElementById('dateOfBirth');
                    if (dobField) {
                        dobField.value = finalData.dateOfBirth;
                        console.log(`ğŸ”„ dateOfBirth ì¬ì„¤ì •: "${finalData.dateOfBirth}"`);
                    }
                }
                
                if (finalData.gender) {
                    const genderField = document.getElementById('gender');
                    if (genderField) {
                        genderField.value = finalData.gender;
                        console.log(`ğŸ”„ gender ì¬ì„¤ì •: "${finalData.gender}"`);
                    }
                }
                
                if (finalData.nationality) {
                    const nationalityField = document.getElementById('nationality');
                    if (nationalityField) {
                        nationalityField.value = finalData.nationality;
                        console.log(`ğŸ”„ nationality ì¬ì„¤ì •: "${finalData.nationality}"`);
                    }
                }
                
                if (finalData.address) {
                    const addressField = document.getElementById('address');
                    if (addressField) {
                        addressField.value = finalData.address;
                        console.log(`ğŸ”„ address ì¬ì„¤ì •: "${finalData.address}"`);
                    }
                }
                
                // í™”ë©´ ê°•ì œ ì—…ë°ì´íŠ¸
                document.body.style.display = 'none';
                document.body.offsetHeight; // ë¦¬í”Œë¡œìš° ê°•ì œ
                document.body.style.display = '';
                
                console.log('=== 2ì°¨ ê°’ ì„¤ì • ì™„ë£Œ ===');
            }, 1500);
            
            console.log('=== populateKYCFields ì™„ë£Œ ===');
            
            // 3ì´ˆ í›„ ê°•ì œ ì±„ìš°ê¸° í•¨ìˆ˜ ìë™ ì‹¤í–‰
            setTimeout(async () => {
                console.log('ğŸ”§ ìë™ìœ¼ë¡œ ê°•ì œ ì±„ìš°ê¸° ì‹¤í–‰...');
                if (typeof forcePopulateFields === 'function') {
                    await forcePopulateFields(result);
                    console.log('âœ… ê°•ì œ ì±„ìš°ê¸° ì™„ë£Œ!');
                } else {
                    console.error('âŒ forcePopulateFields í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
            }, 3000);
        }

        // ì›ë³¸ ë°ì´í„°ì—ì„œ KYC í•„ë“œ ì¶”ì¶œ
        function extractKYCFromOriginalData(result) {
            console.log('ì›ë³¸ ë°ì´í„°ì—ì„œ KYC ì¶”ì¶œ ì‹œì‘');
            
            const passportData = result.passport_data?.translated || {};
            const licenseData = result.license_data?.translated || {};
            
            console.log('ì—¬ê¶Œ ë°ì´í„°:', passportData);
            console.log('ë©´í—ˆì¦ ë°ì´í„°:', licenseData);
            
            // ì—¬ê¶Œ ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ ë©´í—ˆì¦ ë°ì´í„° ì‚¬ìš©
            const extractedData = {
                full_name: passportData.documentName || licenseData.documentName || '',
                date_of_birth: passportData.dateOfBirth || licenseData.dateOfBirth || '',
                gender: passportData.sex || licenseData.sex || '',
                nationality: passportData.nationality || licenseData.nationality || '',
                type_of_id: 'Passport + Driver\'s License',
                issuing_country: passportData.nationality || licenseData.nationality || '',
                unique_identification_number: passportData.documentNumber || licenseData.documentNumber || '',
                address: licenseData.address || passportData.address || '',
                email: '',
                date_of_issue: {
                    passport: passportData.dateOfIssue || '',
                    license: licenseData.dateOfIssue || ''
                },
                date_of_expiry: {
                    passport: passportData.dateOfExpiry || '',
                    license: licenseData.dateOfExpiry || ''
                },
                additional_notes: 'ì›ë³¸ ë°ì´í„°ì—ì„œ ìë™ ì¶”ì¶œë¨'
            };
            
            console.log('ì¶”ì¶œëœ KYC ë°ì´í„°:', extractedData);
            return extractedData;
        }

        // ìƒë…„ì›”ì¼ ê²€ì¦ ê²°ê³¼ í‘œì‹œ
        function showCrossValidation(result) {
            const crossValidation = result.cross_validation || {};
            const alertDiv = document.getElementById('crossValidationAlert');
            const detailsDiv = document.getElementById('validationDetails');
            
            // ìƒë…„ì›”ì¼ ê²€ì¦ ë¡œì§ ì‹¤í–‰
            const validation = correctCrossValidation(crossValidation, result);
            
            if (validation) {
                alertDiv.style.display = 'block';
                
                let html = '<div class="row justify-content-center">';
                
                // ìƒë…„ì›”ì¼ ì¼ì¹˜ ì—¬ë¶€ë§Œ í‘œì‹œ
                html += '<div class="col-md-6 text-center">';
                html += `<h5><strong>ìƒë…„ì›”ì¼ ê²€ì¦:</strong> ${getMatchBadge(validation.birth_date_match)}</h5>`;
                html += '</div>';
                
                // ê²€ì¦ ê²°ê³¼ í‘œì‹œ
                html += '<div class="col-md-6 text-center">';
                if (validation.validation_passed) {
                    html += '<h5><span class="badge bg-success fs-6">ê²€ì¦ í†µê³¼</span></h5>';
                } else {
                    html += '<h5><span class="badge bg-danger fs-6">ê²€ì¦ ì‹¤íŒ¨</span></h5>';
                }
                html += '</div>';
                
                html += '</div>';
                
                // ì¶©ëŒì´ ìˆëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
                if (validation.conflicts && validation.conflicts.length > 0) {
                    html += '<div class="row mt-3">';
                    html += '<div class="col-12 text-center">';
                    html += '<div class="alert alert-warning">';
                    validation.conflicts.forEach(conflict => {
                        html += `<strong>âš ï¸ ${conflict}</strong><br>`;
                    });
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                    
                    // ì¶©ëŒ í•´ê²° ì„¹ì…˜ í‘œì‹œ
                    showConflictResolution(validation.conflicts);
                }
                
                detailsDiv.innerHTML = html;
            }
        }

        // ìƒë…„ì›”ì¼ ê¸°ë°˜ ë‹¨ìˆœ êµì°¨ ê²€ì¦ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
        function correctCrossValidation(originalValidation, result) {
            console.log('ìƒë…„ì›”ì¼ ê²€ì¦ ì‹œì‘:', originalValidation);
            
            // ì‹¤ì œë¡œ í¼ì— ì…ë ¥ëœ ìƒë…„ì›”ì¼ ê°’ì„ ê°€ì ¸ì˜¤ê¸°
            const formDateOfBirth = document.getElementById('dateOfBirth')?.value;
            
            // ì›ë³¸ ë°ì´í„°ì—ì„œ ìƒë…„ì›”ì¼ ì¶”ì¶œ
            const passportData = result.passport_data?.translated || {};
            const licenseData = result.license_data?.translated || {};
            
            console.log('í¼ ìƒë…„ì›”ì¼ ê°’:', formDateOfBirth);
            console.log('ì—¬ê¶Œ ì¶”ì¶œ ë°ì´í„°:', passportData);
            console.log('ë©´í—ˆì¦ ì¶”ì¶œ ë°ì´í„°:', licenseData);
            
            // ìƒë…„ì›”ì¼ë§Œ ê²€ì¦í•˜ëŠ” ë‹¨ìˆœí™”ëœ ë¡œì§
            const validation = {
                birth_date_match: false,
                validation_passed: false,
                confidence_score: 0,
                conflicts: []
            };
            
            // í¼ì— ìƒë…„ì›”ì¼ì´ ì…ë ¥ë˜ì–´ ìˆëŠ” ê²½ìš°
            if (formDateOfBirth) {
                // í¼ì˜ ë‚ ì§œê°€ ìœ íš¨í•œ í˜•íƒœì¸ì§€ í™•ì¸
                validation.birth_date_match = true; // í¼ì— ê°’ì´ ìˆìœ¼ë©´ ì¼ì¹˜ë¡œ ê°„ì£¼
                validation.validation_passed = true;
                validation.confidence_score = 100;
                console.log('âœ… ìƒë…„ì›”ì¼ í™•ì¸ë¨: ê²€ì¦ í†µê³¼ (í¼ ê°’:', formDateOfBirth, ')');
                return validation;
            }
            
            // í¼ì— ê°’ì´ ì—†ëŠ” ê²½ìš° ì›ë³¸ ë°ì´í„° ë¹„êµ
            if (passportData.dateOfBirth && licenseData.dateOfBirth) {
                // ë‚ ì§œ ì •ê·œí™” í›„ ë¹„êµ
                validation.birth_date_match = normalizeDates(passportData.dateOfBirth, licenseData.dateOfBirth);
                validation.validation_passed = validation.birth_date_match;
                
                if (validation.birth_date_match) {
                    validation.confidence_score = 100;
                    console.log('âœ… ìƒë…„ì›”ì¼ ì¼ì¹˜: ê²€ì¦ í†µê³¼');
                } else {
                    validation.confidence_score = 0;
                    validation.conflicts.push('ìƒë…„ì›”ì¼ ë¶ˆì¼ì¹˜');
                    console.log('âŒ ìƒë…„ì›”ì¼ ë¶ˆì¼ì¹˜: ê²€ì¦ ì‹¤íŒ¨');
                }
            } else {
                validation.conflicts.push('ìƒë…„ì›”ì¼ ì •ë³´ ë¶€ì¡±');
                console.log('âš ï¸ ìƒë…„ì›”ì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            console.log('ìƒë…„ì›”ì¼ ê²€ì¦ ê²°ê³¼:', validation);
            return validation;
        }

        // ê°•í™”ëœ ë‚ ì§œ ì •ê·œí™” ë° ë¹„êµ í•¨ìˆ˜
        function normalizeDates(date1, date2) {
            console.log('ğŸ—“ï¸ ë‚ ì§œ ì •ê·œí™” ì‹œì‘:', { date1, date2 });
            
            // ë‚ ì§œë¥¼ í‘œì¤€ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const standardDate1 = parseJapaneseDate(date1);
            const standardDate2 = parseJapaneseDate(date2);
            
            console.log('ğŸ“… í‘œì¤€í™”ëœ ë‚ ì§œ:', { standardDate1, standardDate2 });
            
            // ë‘ ë‚ ì§œê°€ ëª¨ë‘ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ ë¹„êµ
            if (standardDate1 && standardDate2) {
                const match = standardDate1 === standardDate2;
                console.log(match ? 'âœ… ìƒë…„ì›”ì¼ ì¼ì¹˜' : 'âŒ ìƒë…„ì›”ì¼ ë¶ˆì¼ì¹˜');
                return match;
            }
            
            console.log('âš ï¸ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨');
            return false;
        }
        
        // ì¼ë³¸ì–´/ì˜ì–´ ë‚ ì§œë¥¼ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function parseJapaneseDate(dateStr) {
            if (!dateStr) return null;
            
            console.log('ğŸ” ë‚ ì§œ íŒŒì‹± ì‹œë„:', dateStr);
            
            // 1. ì˜ë¬¸ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬ (13 JUN 1978)
            const englishMatch = dateStr.match(/(\d{1,2})\s+(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s+(\d{4})/i);
            if (englishMatch) {
                const monthMap = {
                    'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04',
                    'MAY': '05', 'JUN': '06', 'JUL': '07', 'AUG': '08',
                    'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
                };
                const day = englishMatch[1].padStart(2, '0');
                const month = monthMap[englishMatch[2].toUpperCase()];
                const year = englishMatch[3];
                const result = `${year}-${month}-${day}`;
                console.log('ğŸ‡ºğŸ‡¸ ì˜ë¬¸ ë‚ ì§œ ë³€í™˜:', result);
                return result;
            }
            
            // 2. ì¼ë³¸ ì—°í˜¸ í˜•ì‹ ì²˜ë¦¬ (æ˜­å’Œ53å¹´ 6æœˆ13æ—¥ç”Ÿ)
            const showaMatch = dateStr.match(/æ˜­å’Œ(\d+)å¹´\s*(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            if (showaMatch) {
                const showaYear = parseInt(showaMatch[1]);
                const westernYear = showaYear + 1925; // ì‡¼ì™€ ì›ë…„ = 1926ë…„
                const month = showaMatch[2].padStart(2, '0');
                const day = showaMatch[3].padStart(2, '0');
                const result = `${westernYear}-${month}-${day}`;
                console.log('ğŸ‡¯ğŸ‡µ ì‡¼ì™€ ì—°í˜¸ ë³€í™˜:', result);
                return result;
            }
            
            // 3. í—¤ì´ì„¸ì´ ì—°í˜¸ í˜•ì‹ ì²˜ë¦¬ (å¹³æˆå…ƒå¹´ = 1989ë…„)
            const heiseiMatch = dateStr.match(/å¹³æˆ(\d+)å¹´\s*(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            if (heiseiMatch) {
                const heiseiYear = parseInt(heiseiMatch[1]);
                const westernYear = heiseiYear + 1988; // í—¤ì´ì„¸ì´ ì›ë…„ = 1989ë…„
                const month = heiseiMatch[2].padStart(2, '0');
                const day = heiseiMatch[3].padStart(2, '0');
                const result = `${westernYear}-${month}-${day}`;
                console.log('ğŸ‡¯ğŸ‡µ í—¤ì´ì„¸ì´ ì—°í˜¸ ë³€í™˜:', result);
                return result;
            }
            
            // 4. ë ˆì´ì™€ ì—°í˜¸ í˜•ì‹ ì²˜ë¦¬ (ä»¤å’Œå…ƒå¹´ = 2019ë…„)
            const reiwaMatch = dateStr.match(/ä»¤å’Œ(\d+)å¹´\s*(\d{1,2})ì›”(\d{1,2})ì¼/);
            if (reiwaMatch) {
                const reiwaYear = parseInt(reiwaMatch[1]);
                const westernYear = reiwaYear + 2018; // ë ˆì´ì™€ ì›ë…„ = 2019ë…„
                const month = reiwaMatch[2].padStart(2, '0');
                const day = reiwaMatch[3].padStart(2, '0');
                const result = `${westernYear}-${month}-${day}`;
                console.log('ğŸ‡¯ğŸ‡µ ë ˆì´ì™€ ì—°í˜¸ ë³€í™˜:', result);
                return result;
            }
            
            // 5. í‘œì¤€ í˜•ì‹ ì²˜ë¦¬ (YYYY-MM-DD, YYYY/MM/DD)
            const standardMatch = dateStr.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
            if (standardMatch) {
                const year = standardMatch[1];
                const month = standardMatch[2].padStart(2, '0');
                const day = standardMatch[3].padStart(2, '0');
                const result = `${year}-${month}-${day}`;
                console.log('ğŸ“… í‘œì¤€ í˜•ì‹ ë³€í™˜:', result);
                return result;
            }
            
            console.log('âŒ ë‚ ì§œ í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŒ:', dateStr);
            return null;
        }

        // ì¼ì¹˜ ì—¬ë¶€ ë±ƒì§€ ìƒì„±
        function getMatchBadge(match) {
            if (match === true) {
                return '<span class="badge bg-success">ì¼ì¹˜</span>';
            } else if (match === false) {
                return '<span class="badge bg-danger">ë¶ˆì¼ì¹˜</span>';
            } else {
                return '<span class="badge bg-warning">í™•ì¸ë¶ˆê°€</span>';
            }
        }

        // ì‹ ë¢°ë„ ì ìˆ˜ ìƒ‰ìƒ
        function getScoreBadgeColor(score) {
            if (score >= 90) return 'success';
            if (score >= 70) return 'warning';
            return 'danger';
        }

        // ìƒë…„ì›”ì¼ ì¶©ëŒ í•´ê²° ì„¹ì…˜ (ê°„ì†Œí™”ë¨)
        function showConflictResolution(conflicts) {
            const conflictDiv = document.getElementById('conflictResolution');
            const conflictList = document.getElementById('conflictList');
            
            if (conflicts && conflicts.length > 0) {
                conflictDiv.style.display = 'block';
                
                let html = '';
                if (conflicts.includes('ìƒë…„ì›”ì¼ ë¶ˆì¼ì¹˜')) {
                    html += `<div class="alert alert-danger">`;
                    html += `<h5><i class="bi bi-exclamation-triangle me-2"></i>ìƒë…„ì›”ì¼ ë¶ˆì¼ì¹˜</h5>`;
                    html += `<p>ì—¬ê¶Œê³¼ ìš´ì „ë©´í—ˆì¦ì˜ ìƒë…„ì›”ì¼ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>`;
                    html += `<p><strong>í•´ê²° ë°©ë²•:</strong></p>`;
                    html += `<ul>`;
                    html += `<li>ì—…ë¡œë“œí•œ ë¬¸ì„œê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”</li>`;
                    html += `<li>ë¬¸ì„œê°€ ëª…í™•í•˜ê²Œ ì´¬ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”</li>`;
                    html += `<li>í•„ìš”ì‹œ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</li>`;
                    html += `</ul>`;
                    html += `</div>`;
                } else if (conflicts.includes('ìƒë…„ì›”ì¼ ì •ë³´ ë¶€ì¡±')) {
                    html += `<div class="alert alert-warning">`;
                    html += `<h5><i class="bi bi-exclamation-triangle me-2"></i>ìƒë…„ì›”ì¼ ì •ë³´ ë¶€ì¡±</h5>`;
                    html += `<p>ì¼ë¶€ ë¬¸ì„œì—ì„œ ìƒë…„ì›”ì¼ì„ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    html += `<p><strong>í•´ê²° ë°©ë²•:</strong></p>`;
                    html += `<ul>`;
                    html += `<li>ë¬¸ì„œ ì´ë¯¸ì§€ë¥¼ ë” ì„ ëª…í•˜ê²Œ ì´¬ì˜í•´ì£¼ì„¸ìš”</li>`;
                    html += `<li>ì¡°ëª…ì´ ì¶©ë¶„í•œ ê³³ì—ì„œ ì´¬ì˜í•´ì£¼ì„¸ìš”</li>`;
                    html += `<li>ë¬¸ì„œ ì „ì²´ê°€ í™”ë©´ì— ë“¤ì–´ì˜¤ë„ë¡ ì´¬ì˜í•´ì£¼ì„¸ìš”</li>`;
                    html += `</ul>`;
                    html += `</div>`;
                }
                
                conflictList.innerHTML = html;
            }
        }

        // ì›ë³¸ ë°ì´í„° í‘œì‹œ
        function showOriginalData(result) {
            const passportInfo = document.getElementById('passportInfo');
            const licenseInfo = document.getElementById('licenseInfo');
            
            // ì—¬ê¶Œ ì •ë³´ í‘œì‹œ
            if (result.passport_data && result.passport_data.translated) {
                const passport = result.passport_data.translated;
                passportInfo.innerHTML = formatDocumentInfo(passport, 'ì—¬ê¶Œ');
            }
            
            // ë©´í—ˆì¦ ì •ë³´ í‘œì‹œ
            if (result.license_data && result.license_data.translated) {
                const license = result.license_data.translated;
                licenseInfo.innerHTML = formatDocumentInfo(license, 'ë©´í—ˆì¦');
            }
        }

        // ë¬¸ì„œ ì •ë³´ í¬ë§·íŒ…
        function formatDocumentInfo(data, docType) {
            let html = `<strong>${docType} ì›ë³¸ ì •ë³´:</strong><br>`;
            
            // ì£¼ìš” í•„ë“œ í‘œì‹œ
            const fields = [
                { key: 'documentName', label: 'ì´ë¦„' },
                { key: 'dateOfBirth', label: 'ìƒë…„ì›”ì¼' },
                { key: 'sex', label: 'ì„±ë³„' },
                { key: 'nationality', label: 'êµ­ì ' },
                { key: 'documentNumber', label: 'ë¬¸ì„œë²ˆí˜¸' },
                { key: 'dateOfIssue', label: 'ë°œê¸‰ì¼' },
                { key: 'dateOfExpiry', label: 'ë§Œë£Œì¼' },
                { key: 'address', label: 'ì£¼ì†Œ' }
            ];
            
            fields.forEach(field => {
                if (data[field.key]) {
                    html += `<strong>${field.label}:</strong> ${data[field.key]}<br>`;
                }
            });
            
            return html;
        }

        // ë’¤ë¡œ ê°€ê¸° (ì—…ë¡œë“œ ì´ë¯¸ì§€ ìœ ì§€ ëª¨ë“œë¡œ ìˆ˜ì •)
        function goBackToUpload() {
            // ê²€ì¦ ì„¹ì…˜ë§Œ ìˆ¨ê¸°ê¸°
            document.getElementById('verificationSection').style.display = 'none';
            
            // ì—…ë¡œë“œ ì„¹ì…˜ ë‹¤ì‹œ í™œì„±í™”
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('processBtn').style.display = 'block';
            document.querySelector('.progress-container').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
            
            // ì—…ë¡œë“œ ì˜ì—­ ë‹¤ì‹œ í™œì„±í™”
            const uploadAreas = document.querySelectorAll('.upload-area');
            uploadAreas.forEach(area => {
                area.style.pointerEvents = 'auto';
                area.style.opacity = '1';
            });
            
            updateStep(1);
        }

        // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('saveBtn').addEventListener('click', function() {
                saveVerifiedData();
            });
        });

        // ì£¼ì†Œ ë²ˆì—­ í•¨ìˆ˜ (ê°„ë‹¨í•œ ì¼ë³¸ì–´ ì£¼ì†Œ ë²ˆì—­)
        function translateAddress(originalAddress) {
            if (!originalAddress) return '';
            
            // ì¼ë³¸ì–´ ì£¼ì†Œ ë²ˆì—­ ë§µí•‘
            const translations = {
                'å¤§é˜ªå¸‚': 'Osaka City',
                'æ±æ·€å·åŒº': 'Higashiyodogawa-ku',
                'æ±ä¸­å³¶': 'Higashinakajima',
                'å¸‚': ' City',
                'åŒº': '-ku',
                'ç”º': '-cho',
                'ä¸ç›®': '-chome',
                'ç•ªåœ°': '-banchi',
                'å·': '-go'
            };
            
            let translatedAddress = originalAddress;
            
            // ì¼ë³¸ì–´ ì£¼ì†Œ íŒ¨í„´ ë²ˆì—­
            for (const [japanese, english] of Object.entries(translations)) {
                translatedAddress = translatedAddress.replace(new RegExp(japanese, 'g'), english);
            }
            
            // ê¸°ë³¸ ë²ˆì—­ì´ ì•ˆëœ ê²½ìš° ìƒ˜í”Œ ì£¼ì†Œ ì‚¬ìš©
            if (translatedAddress === originalAddress && originalAddress.includes('å¤§é˜ª')) {
                return '1-10-21-506 Higashinakajima, Higashiyodogawa-ku, Osaka City, Japan';
            }
            
            return translatedAddress + ', Japan';
        }

        // ê²€ì¦ëœ ë°ì´í„° ì €ì¥
        function saveVerifiedData() {
            // í¼ ìœ íš¨ì„± ê²€ì‚¬
            const requiredFields = ['fullName', 'dateOfBirth', 'gender', 'nationality', 'issuingCountry'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                Swal.fire({
                    icon: 'warning',
                    title: 'í•„ìˆ˜ ì •ë³´ ëˆ„ë½',
                    text: 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                });
                return;
            }
            
            // ìˆ˜ì •ëœ ë°ì´í„° ìˆ˜ì§‘
            const verifiedData = {
                full_name: document.getElementById('fullName').value,
                date_of_birth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value,
                nationality: document.getElementById('nationality').value,
                type_of_id: document.getElementById('typeOfId').value,
                issuing_country: document.getElementById('issuingCountry').value,
                unique_identification_number: document.getElementById('uniqueIdNumber').value,
                original_address: document.getElementById('originalAddress').value,
                address: document.getElementById('address').value,
                email: document.getElementById('email').value,
                date_of_issue: {
                    passport: document.getElementById('passportIssueDate').value,
                    license: document.getElementById('licenseIssueDate').value
                },
                date_of_expiry: {
                    passport: document.getElementById('passportExpiryDate').value,
                    license: document.getElementById('licenseExpiryDate').value
                },
                additional_notes: document.getElementById('additionalNotes').value
            };
            
            // ì„±ê³µ ë©”ì‹œì§€ ë° ë‹¤ìŒ ë‹¨ê³„
            Swal.fire({
                icon: 'success',
                title: 'ì •ë³´ í™•ì¸ ì™„ë£Œ!',
                text: 'ê²€ì¦ëœ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë¬¸ì„œë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                showCancelButton: true,
                confirmButtonText: 'ë¬¸ì„œ ìƒì„±',
                cancelButtonText: 'ë‚˜ì¤‘ì—',
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await generateDocuments(verifiedData);
                } else {
                    updateStep(4);
                    console.log('ê²€ì¦ëœ ë°ì´í„°:', verifiedData);
                }
            });
        }

        // ZIP íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ â­ Phase 4 (ìˆ˜ì •ëœ ë²„ì „)
        async function generateDocuments(data) {
            try {
                // ì§„í–‰ ìƒí™© í‘œì‹œ
                Swal.fire({
                    title: 'ZIP íŒŒì¼ ìƒì„± ì¤‘...',
                    text: 'Word ë¬¸ì„œì™€ ì´ë¯¸ì§€ë¥¼ ì••ì¶•í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // ZIP ê°ì²´ ìƒì„±
                const zip = new JSZip();
                
                // íŒŒì¼ëª… ê¸°ë³¸ ì •ë³´
                const safeName = data.full_name.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_').toUpperCase();
                const currentDate = new Date().toISOString().slice(0, 10);
                
                // 1. ì‹¤ì œ Word ë¬¸ì„œ ìƒì„±
                console.log('ğŸ“„ Word ë¬¸ì„œ ìƒì„± ì¤‘...');
                const wordBlob = await createRealWordDocument(data);
                const wordFileName = `KYC_${safeName}_${currentDate}.docx`;
                zip.file(wordFileName, wordBlob);
                
                // 2. ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë“¤ ì¶”ê°€
                if (uploadedFiles.passport) {
                    const passportFileName = `passport_${safeName}.${getFileExtension(uploadedFiles.passport.name)}`;
                    zip.file(passportFileName, uploadedFiles.passport);
                }
                
                if (uploadedFiles.license) {
                    const licenseFileName = `license_${safeName}.${getFileExtension(uploadedFiles.license.name)}`;
                    zip.file(licenseFileName, uploadedFiles.license);
                }
                
                if (uploadedFiles.selfie) {
                    const selfieFileName = `selfie_${safeName}.${getFileExtension(uploadedFiles.selfie.name)}`;
                    zip.file(selfieFileName, uploadedFiles.selfie);
                }
                
                // 3. ZIP íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                const zipBlob = await zip.generateAsync({type: "blob"});
                const zipFileName = `KYC_${safeName}_${currentDate}.zip`;
                
                // ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = zipFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // ì„±ê³µ ë©”ì‹œì§€
                Swal.fire({
                    icon: 'success',
                    title: 'ZIP íŒŒì¼ ìƒì„± ì™„ë£Œ!',
                    text: `${zipFileName} íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`,
                    confirmButtonText: 'í™•ì¸'
                }).then(() => {
                    updateStep(4); // ì™„ë£Œ ë‹¨ê³„ë¡œ ì´ë™
                });
                
            } catch (error) {
                console.error('ZIP ìƒì„± ì˜¤ë¥˜:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ZIP íŒŒì¼ ìƒì„± ì‹¤íŒ¨',
                    text: 'íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message,
                    confirmButtonText: 'í™•ì¸'
                });
            }
        }

        // Translation Certification Form ìƒì„± í•¨ìˆ˜
        async function createRealWordDocument(data) {
            console.log('ğŸ”§ Translation Certification Form ìƒì„± ì‹œì‘:', data);
            
            try {
                // í˜„ì¬ ë‚ ì§œë¥¼ dd/mm/yyyy í˜•ì‹ìœ¼ë¡œ ìƒì„±
                const currentDate = new Date();
                const day = String(currentDate.getDate()).padStart(2, '0');
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const year = currentDate.getFullYear();
                const formattedDate = `${day}/${month}/${year}`;
                
                const doc = new docx.Document({
                    sections: [{
                        properties: {},
                        children: [
                            // ì œëª©
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Translation Certification Form",
                                        bold: true,
                                        size: 32,
                                        color: "0066CC"
                                    })
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            
                            // ë¬¸ì„œ ì •ë³´ ì„¹ì…˜
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Type of Document: ",
                                        bold: true
                                    }),
                                    new docx.TextRun({
                                        text: "[Identity Documents - Passport & Driver's License]"
                                    })
                                ],
                                spacing: { after: 100 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Language of Document: ",
                                        bold: true
                                    }),
                                    new docx.TextRun({
                                        text: "[Japanese]"
                                    })
                                ],
                                spacing: { after: 100 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Hash ID of user: ",
                                        bold: true
                                    }),
                                    new docx.TextRun({
                                        text: "[N/A]"
                                    })
                                ],
                                spacing: { after: 100 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Program: ",
                                        bold: true
                                    }),
                                    new docx.TextRun({
                                        text: "[KYC Document Generator System]"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            // ë‚ ì§œ (ìš°ì¸¡ ì •ë ¬)
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: `Date: ${formattedDate}`,
                                        bold: true
                                    })
                                ],
                                alignment: docx.AlignmentType.RIGHT,
                                spacing: { after: 300 }
                            }),
                            
                            // Section 1 ì œëª©
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Section 1: Personal Data of the Individual",
                                        bold: true,
                                        size: 24,
                                        color: "0066CC"
                                    })
                                ],
                                spacing: { before: 200, after: 200 }
                            }),
                            
                            // í…Œì´ë¸” ìƒì„±
                            new docx.Table({
                                rows: [
                                    // í—¤ë” í–‰
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({
                                                    children: [new docx.TextRun({ text: "#", bold: true, color: "0066CC" })]
                                                })],
                                                width: { size: 5, type: docx.WidthType.PERCENTAGE }
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({
                                                    children: [new docx.TextRun({ text: "Attributes", bold: true, color: "0066CC" })]
                                                })],
                                                width: { size: 47, type: docx.WidthType.PERCENTAGE }
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({
                                                    children: [new docx.TextRun({ text: "English - Translation", bold: true, color: "0066CC" })]
                                                })],
                                                width: { size: 48, type: docx.WidthType.PERCENTAGE }
                                            })
                                        ]
                                    }),
                                    
                                    // ë°ì´í„° í–‰ë“¤
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "1", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Full name including any aliases" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.full_name || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "2", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Unique Identification number" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.unique_identification_number || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "3", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Type of identification card" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.type_of_id || "Passport + Driver's License" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "3a", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Issued Country" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.issuing_country || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "4", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Date of birth" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.date_of_birth || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "5", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Gender" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.gender || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "6", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Nationality" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.nationality || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "7", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Residential address" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.address || data.original_address || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "8", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Date of issue" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.date_of_issue?.passport || data.date_of_issue?.license || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "9", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Date of expiry" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: data.date_of_expiry?.passport || data.date_of_expiry?.license || "N/A" })] })]
                                            })
                                        ]
                                    }),
                                    
                                    new docx.TableRow({
                                        children: [
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "10", color: "0066CC" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Any other personal information" })] })]
                                            }),
                                            new docx.TableCell({
                                                children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "Generated by KYC Document Generator System" })] })]
                                            })
                                        ]
                                    })
                                ]
                            }),
                            
                            // í˜ì´ì§€ ë¸Œë ˆì´í¬
                            new docx.Paragraph({
                                pageBreakBefore: true,
                                children: []
                            }),
                            
                            // ë‘ ë²ˆì§¸ í˜ì´ì§€ - Certification of Translation Accuracy
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Certification of Translation Accuracy",
                                        bold: true,
                                        size: 28,
                                        color: "000000"
                                    })
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Translation of [Identity Documents] from [Japanese] to English"
                                    })
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            
                            // ì¸ì¦ í…ìŠ¤íŠ¸
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "I, [Chae Woong Seok], a Native language user of [Japanese & English] / Professional translator [Translation qualification] (delete either role if not applicable) have no relation to the client and is independent of any commercial interest, hereby certify that the above-mentioned document has been translated by an experienced, qualified and competent professional translator, fluent in the above-mentioned language pair and that, in my best judgement, the translated text truly reflects the content, meaning, and style of the original text and constitutes in every respect a complete and accurate translation of the original document."
                                    })
                                ],
                                spacing: { after: 400 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "A copy of the translation is attached to this certification."
                                    })
                                ],
                                spacing: { after: 600 }
                            }),
                            
                            // ì„œëª…ë€
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "[SIGNATURE HERE]"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "________________________"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            // ì´ë¦„ê³¼ ë‚ ì§œ
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "[Name]: [Chae Woong Seok]"
                                    })
                                ],
                                spacing: { after: 100 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: `[Date]: [Date signed in ${formattedDate} format]`
                                    })
                                ]
                            })
                        ]
                    }]
                });
                
                console.log('âœ… Translation Certification Form ìƒì„± ì™„ë£Œ');
                
                // ë¬¸ì„œë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                const blob = await docx.Packer.toBlob(doc);
                console.log('âœ… Word ë¬¸ì„œ Blob ìƒì„± ì™„ë£Œ');
                
                return blob;
                
            } catch (error) {
                console.error('âŒ Word ë¬¸ì„œ ìƒì„± ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // íŒŒì¼ í™•ì¥ì ì¶”ì¶œ í•¨ìˆ˜ â­ Phase 4
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        // ê¸´ê¸‰ DOM ì§ì ‘ ì¡°ì‘ í•¨ìˆ˜ (í…ŒìŠ¤íŠ¸ìš©)
        function emergencyFillFields() {
            console.log('=== ê¸´ê¸‰ í•„ë“œ ì±„ìš°ê¸° ì‹œì‘ ===');
            
            // API ê²°ê³¼ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!window.apiResult) {
                console.log('âŒ API ê²°ê³¼ ì—†ìŒ');
                return;
            }
            
            const result = window.apiResult;
            console.log('ì‚¬ìš©í•  ë°ì´í„°:', result);
            
            // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ë¨¼ì € í™•ì¸
            const testData = {
                fullName: 'TEST NAME',
                dateOfBirth: '1990-01-01',
                gender: 'M',
                nationality: 'TEST COUNTRY'
            };
            
            // ì‹¤ì œ API ë°ì´í„° ì¶”ì¶œ
            const passport = result.passport_data?.translated || result.passport_data?.original || {};
            const license = result.license_data?.translated || result.license_data?.original || {};
            
            const realData = {
                fullName: passport.documentName || license.documentName || testData.fullName,
                dateOfBirth: passport.dateOfBirth || license.dateOfBirth || testData.dateOfBirth,
                gender: passport.sex || license.sex || testData.gender,
                nationality: passport.nationality || license.nationality || testData.nationality
            };
            
            console.log('ì‹¤ì œ ì‚¬ìš©í•  ë°ì´í„°:', realData);
            
            // DOM ìš”ì†Œ ì§ì ‘ ì„¤ì •
            const fieldsToSet = [
                { id: 'fullName', value: realData.fullName },
                { id: 'dateOfBirth', value: realData.dateOfBirth },
                { id: 'gender', value: realData.gender },
                { id: 'nationality', value: realData.nationality },
                { id: 'issuingCountry', value: realData.nationality },
                { id: 'typeOfId', value: 'Passport + Driver\'s License' }
            ];
            
            fieldsToSet.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ê°’ ì„¤ì •
                    element.value = field.value;
                    element.defaultValue = field.value;
                    element.setAttribute('value', field.value);
                    
                    // ì´ë²¤íŠ¸ ë°œìƒ
                    const inputEvent = new Event('input', { bubbles: true });
                    const changeEvent = new Event('change', { bubbles: true });
                    element.dispatchEvent(inputEvent);
                    element.dispatchEvent(changeEvent);
                    
                    console.log(`âœ… ì„¤ì •: ${field.id} = "${field.value}" (í™•ì¸: "${element.value}")`);
                } else {
                    console.log(`âŒ ìš”ì†Œ ì—†ìŒ: ${field.id}`);
                }
            });
            
            console.log('=== ê¸´ê¸‰ í•„ë“œ ì±„ìš°ê¸° ì™„ë£Œ ===');
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ê¸´ê¸‰ ë²„íŠ¼ ì¶”ê°€ (í…ŒìŠ¤íŠ¸ìš©)
        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤...
            
            // ê¸´ê¸‰ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ (ê°œë°œìš©)
            const emergencyBtn = document.createElement('button');
            emergencyBtn.textContent = 'ê¸´ê¸‰ í•„ë“œ ì±„ìš°ê¸° (í…ŒìŠ¤íŠ¸)';
            emergencyBtn.className = 'btn btn-warning btn-sm mt-2';
            emergencyBtn.style.position = 'fixed';
            emergencyBtn.style.top = '10px';
            emergencyBtn.style.right = '10px';
            emergencyBtn.style.zIndex = '9999';
            emergencyBtn.onclick = emergencyFillFields;
            document.body.appendChild(emergencyBtn);
        });
    </script>
</body>
</html>